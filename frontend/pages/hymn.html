<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hymn - Orthodox Hymns</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="../img/logo.png" alt="Orthodox Hymns Logo">
                <span>Orthodox Hymns</span>
            </div>
            <div class="nav-menu" id="nav-menu">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="categories.html" class="nav-link">Categories</a>
                <a href="languages.html" class="nav-link">Languages</a>
                <a href="favorites.html" class="nav-link">Favorites</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <div class="nav-auth" id="nav-auth">
                    <a href="login.html" class="nav-link">Login</a>
                    <a href="register.html" class="nav-link">Register</a>
                </div>
                <div class="nav-user" id="nav-user" style="display: none;">
                    <span id="user-name"></span>
                    <a href="#" id="logout-btn" class="nav-link">Logout</a>
                    <a href="admin.html" id="admin-link" class="nav-link" style="display: none;">Admin</a>
                </div>
            </div>
            <div class="hamburger" id="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <div id="flash-messages"></div>

    <section class="hymn-detail">
        <div class="container">
            <div id="hymn-detail-content">
                <!-- Hymn details will be loaded here -->
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Orthodox Hymns</h3>
                    <p>Preserving and sharing the sacred music traditions of Orthodox Christianity.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="categories.html">Categories</a></li>
                        <li><a href="languages.html">Languages</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Connect With Us</h4>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Orthodox Hymns. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const hymnId = urlParams.get('id');
            
            if (hymnId) {
                loadHymnDetails(hymnId);
            } else {
                window.location.href = '../index.html';
            }
        });

        async function loadHymnDetails(hymnId) {
            try {
                const response = await fetch(`/api/hymns/${hymnId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayHymnDetails(data.data.hymn);
                } else {
                    console.error('Error loading hymn details:', data.message);
                    auth.showFlash('Error loading hymn details', 'error');
                    window.location.href = '../index.html';
                }
            } catch (error) {
                console.error('Error loading hymn details:', error);
                auth.showFlash('Error loading hymn details', 'error');
                window.location.href = '../index.html';
            }
        }

        function displayHymnDetails(hymn) {
            const hymnContent = document.getElementById('hymn-detail-content');
            if (!hymnContent) return;
            
            hymnContent.innerHTML = `
                <div class="hymn-header">
                    <h2>${hymn.title}</h2>
                    <p><strong>Category:</strong> ${hymn.category.name} | <strong>Language:</strong> ${hymn.language}</p>
                    <p><strong>Listens:</strong> ${hymn.listens} | <strong>Downloads:</strong> ${hymn.downloads}</p>
                </div>
                
                <div class="audio-player">
                    <audio id="hymn-audio" controls style="width: 100%;">
                        <source src="${hymn.audioUrl}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <p id="audio-error" style="color: red; display: none;">Error: Unable to play audio. Please try downloading or contact support.</p>
                </div>
                
                <div class="hymn-actions" style="margin: 20px 0; display: flex; gap: 10px;">
                    <button class="btn" onclick="downloadHymn('${hymn._id}')">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="btn" onclick="shareHymn('${hymn._id}')">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                    <button class="btn" onclick="toggleFavorite('${hymn._id}')" id="favorite-btn">
                        <i class="far fa-heart"></i> Add to Favorites
                    </button>
                </div>
                
                <div class="hymn-description">
                    <h3>Description</h3>
                    <p>${hymn.description}</p>
                </div>
                
                <div class="hymn-lyrics">
                    <h3>Lyrics</h3>
                    <pre>${hymn.lyrics}</pre>
                </div>
            `;
            
            // Add audio error handling
            const audioElement = document.getElementById('hymn-audio');
            audioElement.addEventListener('error', () => {
                console.error('Audio playback error:', audioElement.error);
                document.getElementById('audio-error').style.display = 'block';
            });
            
            // Check if already favorited
            checkIfFavorited(hymn._id);
        }

        async function checkIfFavorited(hymnId) {
            if (!auth.user) return;
            
            try {
                const response = await fetch('/api/users/favorites/list', {
                    method: 'GET',
                    headers: auth.getAuthHeader()
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const isFavorited = data.data.favorites.some(fav => fav._id === hymnId);
                    const favoriteBtn = document.getElementById('favorite-btn');
                    
                    if (isFavorited) {
                        favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
                        favoriteBtn.classList.add('btn-danger');
                    } else {
                        favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
                        favoriteBtn.classList.remove('btn-danger');
                    }
                }
            } catch (error) {
                console.error('Error checking favorite status:', error);
                auth.showFlash('Error checking favorite status', 'error');
            }
        }

        async function downloadHymn(hymnId) {
            try {
                await fetch(`/api/hymns/${hymnId}/download`, {
                    method: 'POST'
                });
                
                const response = await fetch(`/api/hymns/${hymnId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const hymn = data.data.hymn;
                    const link = document.createElement('a');
                    link.href = hymn.audioUrl;
                    link.download = `${hymn.title}.mp3`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    auth.showFlash('Download started', 'success');
                }
            } catch (error) {
                console.error('Error downloading hymn:', error);
                auth.showFlash('Error downloading hymn', 'error');
            }
        }

        function shareHymn(hymnId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Orthodox Hymn',
                    text: 'Check out this beautiful Orthodox hymn',
                    url: `${window.location.origin}/pages/hymn.html?id=${hymnId}`
                })
                .then(() => auth.showFlash('Shared successfully', 'success'))
                .catch(error => {
                    console.error('Error sharing:', error);
                    auth.showFlash('Error sharing hymn', 'error');
                });
            } else {
                const shareUrl = `${window.location.origin}/pages/hymn.html?id=${hymnId}`;
                navigator.clipboard.writeText(shareUrl)
                    .then(() => auth.showFlash('Link copied to clipboard', 'success'))
                    .catch(error => {
                        console.error('Error copying link:', error);
                        auth.showFlash('Error copying link', 'error');
                    });
            }
        }

        async function toggleFavorite(hymnId) {
            if (!auth.user) {
                auth.showFlash('Please login to add favorites', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/users/favorites/list', {
                    method: 'GET',
                    headers: auth.getAuthHeader()
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const isFavorited = data.data.favorites.some(fav => fav._id === hymnId);
                    const favoriteBtn = document.getElementById('favorite-btn');
                    
                    if (isFavorited) {
                        await fetch(`/api/users/favorites/${hymnId}`, {
                            method: 'DELETE',
                            headers: auth.getAuthHeader()
                        });
                        favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Add to Favorites';
                        favoriteBtn.classList.remove('btn-danger');
                        auth.showFlash('Removed from favorites', 'success');
                    } else {
                        await fetch(`/api/users/favorites/${hymnId}`, {
                            method: 'POST',
                            headers: auth.getAuthHeader()
                        });
                        favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Remove from Favorites';
                        favoriteBtn.classList.add('btn-danger');
                        auth.showFlash('Added to favorites', 'success');
                    }
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                auth.showFlash('Error updating favorites', 'error');
            }
        }
    </script>
</body>
</html>